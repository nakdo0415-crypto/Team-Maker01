<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTP FC Team Maker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK (Compat Version 11.6.1) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <!-- html2canvas for capturing -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* 기본: 이사만루체(Gong Gothic) 웹폰트 적용 */
        @font-face {
            font-family: 'GongGothicMedium';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_20-10@1.0/GongGothicMedium.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'GongGothicBold';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_20-10@1.0/GongGothicBold.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'GongGothicLight';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_20-10@1.0/GongGothicLight.woff') format('woff');
            font-weight: 300;
            font-style: normal;
        }

        :root {
            --main-font: 'GongGothicMedium', sans-serif;
            --bold-font: 'GongGothicBold', sans-serif;
            --light-font: 'GongGothicLight', sans-serif;
        }

        body { 
            font-family: var(--main-font); 
            background-color: #f1f5f9;
            user-select: none;
            -webkit-user-select: none; /* 아이패드 텍스트 선택 방지 */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none; /* 아이패드 롱프레스 메뉴 방지 */
            overscroll-behavior-y: none;
        }
        
        /* CSS 변수를 사용하여 동적 변경 가능하도록 수정 */
        .font-black { font-family: var(--bold-font); font-weight: 700; }
        .font-bold { font-family: var(--main-font); font-weight: 500; }
        .font-light { font-family: var(--light-font); font-weight: 300; }

        /* 팀 카드 호버 애니메이션 제거 */
        .team-card { transition: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        button:active { transform: scale(0.96); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            animation: backdropFadeIn 0.2s ease-out;
        }
        @keyframes backdropFadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 드래그 중인 아이템 스타일 (원본 위치) */
        .dragging {
            opacity: 0.4;
            border: 2px dashed #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(0.95);
            position: relative;
            filter: grayscale(100%);
        }
        .dragging::after {
            content: "이동 중...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-family: var(--bold-font); /* 배지 폰트도 변수 사용 */
            color: #2563eb;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 9999px;
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            z-index: 20;
        }

        /* 모바일 드래그 고스트 카드 */
        .ghost-card {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            opacity: 0.9;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            width: 280px;
            will-change: left, top;
            font-family: var(--main-font); /* 고스트 카드 폰트도 변수 사용 */
        }
        
        /* Dropzone Active Style */
        .dropzone-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.02);
        }

        /* 드래그 가능한 아이템에 대한 터치 액션 설정 (중요: 아이패드 스크롤 간섭 방지) */
        .touch-action-pan-y {
            touch-action: pan-y;
        }
        .touch-action-none {
            touch-action: none;
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[9999]">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-bold text-slate-500 italic text-sm">데이터 동기화 중...</p>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Firebase Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyCAcQzliuWJTB8vPm9gb0vsyR8pIAx7YTw",
            authDomain: "otp-fc-check.firebaseapp.com",
            projectId: "otp-fc-check",
            storageBucket: "otp-fc-check.firebasestorage.app",
            messagingSenderId: "907414776392",
            appId: "1:907414776392:web:0a29a660bb956e5a40467d"
        };

        if (firebase.apps.length) {
            // Already initialized
        } else {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = 'otp-fc-attendance';
        const getCol = (name) => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(name);

        const Icon = {
            Refresh: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
            Heart: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>,
            Bookmark: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>,
            Trash: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Camera: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            Download: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Shield: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            TrendingUp: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            AlertCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Info: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            Settings: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Upload: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Check: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        };

        const getLevelColor = (level) => {
            const l = parseInt(level);
            const n = l > 6 ? l - 6 : l; 
            switch(n) {
                case 1: return 'bg-rose-500 text-white';
                case 2: return 'bg-orange-500 text-white';
                case 3: return 'bg-amber-400 text-slate-800';
                case 4: return 'bg-emerald-500 text-white';
                case 5: return 'bg-blue-500 text-white';
                case 6: return 'bg-violet-500 text-white';
                default: return 'bg-slate-400 text-white';
            }
        };

        const getLevelPoints = (level) => {
            const l = parseInt(level);
            const standardLvl = l > 6 ? l - 6 : l;
            return Math.max(1, 7 - standardLvl); 
        };

        const shuffleArray = (array) => {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        function App() {
            const [members, setMembers] = useState([]);
            const [sessionData, setSessionData] = useState([]);
            const [savedDrafts, setSavedDrafts] = useState([]);
            const [meetingDate, setMeetingDate] = useState('');
            const [meetingTime, setMeetingTime] = useState({ start: '', end: '' }); 
            const [syncManagerName, setSyncManagerName] = useState(''); 
            const [teamingSettings, setTeamingSettings] = useState({ teamCount: 3, keepCouples: true });
            const [teams, setTeams] = useState([]);
            const [isConfirmed, setIsConfirmed] = useState(false); // 확정 상태
            const [activeTab, setActiveTab] = useState('generator');
            const [isCapturing, setIsCapturing] = useState(false);
            const [user, setUser] = useState(null);
            
            // Custom Font State
            const [customFontName, setCustomFontName] = useState('GongGothic'); 
            const [isDraggingFile, setIsDraggingFile] = useState(false);

            // Drag & Drop State
            const [draggedItem, setDraggedItem] = useState(null);
            const [dragOverItem, setDragOverItem] = useState(null);
            
            // Mobile Drag State
            const [mobileGhost, setMobileGhost] = useState(null); // { memberData, initialX, initialY }
            const ghostCardRef = useRef(null); 
            const longPressTimerRef = useRef(null);
            const isScrollingRef = useRef(false);

            const [isSaveModalOpen, setIsSaveModalOpen] = useState(false);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [targetDeleteId, setTargetDeleteId] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);

            const teamRefs = useRef([]);

            // 초기 로드 시 LocalStorage 체크 (새로고침 방지)
            useEffect(() => {
                const savedTeams = localStorage.getItem('otp_confirmed_teams');
                if (savedTeams) {
                    try {
                        const parsed = JSON.parse(savedTeams);
                        setTeams(parsed.teams);
                        setIsConfirmed(true);
                        setActiveTab('results');
                        console.log("Restored confirmed teams from storage");
                    } catch(e) {
                        console.error("Failed to restore teams", e);
                    }
                }
            }, []);

            // 확정 상태일 때 팀 변경 시 자동 저장 (수정 사항 반영)
            useEffect(() => {
                if (isConfirmed && teams.length > 0) {
                    localStorage.setItem('otp_confirmed_teams', JSON.stringify({
                        teams,
                        updatedAt: new Date().toISOString()
                    }));
                }
            }, [teams, isConfirmed]);

            useEffect(() => {
                const init = async () => {
                    try {
                        await auth.signInAnonymously();
                    } catch (e) { 
                        console.error("Auth error:", e);
                        document.getElementById('loading-screen').style.display = 'none';
                    }
                };
                init();
                const unsubscribeAuth = auth.onAuthStateChanged((u) => {
                    if (u) {
                        setUser(u);
                        document.getElementById('loading-screen').style.display = 'none';
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubMembers = getCol('members').onSnapshot(snap => setMembers(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubSession = getCol('weekly_session').onSnapshot(snap => setSessionData(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubSettings = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc('meeting_time').onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        setMeetingDate(data.date || "");
                        setMeetingTime({ start: data.start || "", end: data.end || "" });
                        setSyncManagerName(data.managerName || "");
                    }
                });
                const unsubDrafts = getCol('team_drafts').onSnapshot(snap => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setSavedDrafts(data.sort((a,b) => b.createdAt.localeCompare(a.createdAt)));
                });
                return () => { unsubMembers(); unsubSession(); unsubSettings(); unsubDrafts(); };
            }, [user]);

            useEffect(() => {
                if (draggedItem) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
                return () => { document.body.style.overflow = ''; };
            }, [draggedItem]);

            const selectedList = useMemo(() => {
                if (!meetingDate) return [];
                return sessionData.filter(s => s.date === meetingDate && s.status !== '노쇼');
            }, [sessionData, meetingDate]);

            const levelStats = useMemo(() => {
                const stats = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                selectedList.forEach(p => {
                    const masterInfo = members.find(m => m.id === p.memberId) || {};
                    const l = parseInt(masterInfo.level || p.level || 0);
                    if (l > 0) {
                        const n = l > 6 ? l - 6 : l;
                        if (stats[n] !== undefined) stats[n]++;
                    }
                });
                return stats;
            }, [selectedList, members]);

            const reorderMembersWithGenderRule = (memberList) => {
                const size = memberList.length;
                if (size === 0) return [];

                const females = memberList.filter(m => m.gender === '여성');
                const others = memberList.filter(m => m.gender !== '여성');
                
                const result = new Array(size).fill(null);

                if (females.length > 0 && size > 2) {
                    result[2] = females.shift();
                }
                if (females.length > 0 && size > 5) {
                    result[5] = females.shift();
                }
                
                for (let i = 0; i < size; i++) {
                    if (result[i] === null) {
                        if (others.length > 0) {
                            result[i] = others.shift();
                        } else if (females.length > 0) {
                            result[i] = females.shift();
                        }
                    }
                }
                return result.filter(m => m !== null);
            };

            const generateTeams = () => {
                const { teamCount, keepCouples } = teamingSettings;
                const totalAttendees = selectedList.length;
                if (totalAttendees < teamCount) return;

                // 재편성 시 확정 상태 및 저장된 데이터 초기화
                localStorage.removeItem('otp_confirmed_teams');
                setIsConfirmed(false);

                let pool = selectedList.map(p => {
                    const masterInfo = members.find(m => m.id === p.memberId) || {};
                    const lvl = parseInt(masterInfo.level || p.level || 99);
                    return {
                        ...p,
                        name: masterInfo.name || p.name,
                        level: lvl,
                        points: getLevelPoints(lvl),
                        coupleId: masterInfo.coupleId || '',
                        gender: masterInfo.gender || p.gender || '남성',
                        isGuest: p.isGuest || false
                    };
                });

                let units = [];
                let processedIds = new Set();
                if (keepCouples) {
                    pool.forEach(p => {
                        if (!processedIds.has(p.id)) {
                            if (p.coupleId) {
                                const partner = pool.find(o => o.memberId === p.coupleId && !processedIds.has(o.id));
                                if (partner) {
                                    units.push({ 
                                        members: [p, partner], 
                                        totalPoints: p.points + partner.points,
                                        hasFemale: p.gender === '여성' || partner.gender === '여성',
                                        isTopMale: p.level === 1 || partner.level === 1,
                                        isTopFemale: p.level === 7 || partner.level === 7,
                                        avgSkill: (p.points + partner.points) / 2
                                    });
                                    processedIds.add(p.id); processedIds.add(partner.id);
                                    return;
                                }
                            }
                            units.push({ members: [p], totalPoints: p.points, hasFemale: p.gender === '여성', isTopMale: p.level === 1, isTopFemale: p.level === 7, avgSkill: p.points });
                            processedIds.add(p.id);
                        }
                    });
                } else {
                    units = pool.map(p => ({ members: [p], totalPoints: p.points, hasFemale: p.gender === '여성', isTopMale: p.level === 1, isTopFemale: p.level === 7, avgSkill: p.points }));
                }

                const baseSize = Math.floor(totalAttendees / teamCount);
                const teamsWithExtra = totalAttendees % teamCount;
                const resultTeams = Array.from({ length: teamCount }, (_, i) => ({ 
                    members: [], 
                    scoreSum: 0, 
                    targetSize: baseSize + (i < teamsWithExtra ? 1 : 0),
                    hasTopMale: false,
                    hasTopFemale: false
                }));

                let unitsToAssign = shuffleArray(shuffleArray(units));

                const topMaleUnit = unitsToAssign.find(u => u.isTopMale);
                const topFemaleUnit = unitsToAssign.find(u => u.isTopFemale);

                if (topMaleUnit && topFemaleUnit && teamCount >= 2) {
                    const randomIndices = shuffleArray(Array.from({length: teamCount}, (_, i) => i));
                    const maleIdx = randomIndices[0];
                    const femaleIdx = randomIndices[1];
                    resultTeams[maleIdx].members.push(...topMaleUnit.members);
                    resultTeams[maleIdx].scoreSum += topMaleUnit.totalPoints;
                    resultTeams[maleIdx].hasTopMale = true;
                    resultTeams[femaleIdx].members.push(...topFemaleUnit.members);
                    resultTeams[femaleIdx].scoreSum += topFemaleUnit.totalPoints;
                    resultTeams[femaleIdx].hasTopFemale = true;
                    unitsToAssign = unitsToAssign.filter(u => u !== topMaleUnit && u !== topFemaleUnit);
                }

                const assignByBalancedRandom = (unitList, isFemalePriority = false) => {
                    const sorted = shuffleArray(unitList).sort((a, b) => b.avgSkill - a.avgSkill || Math.random() - 0.5);
                    sorted.forEach(unit => {
                        let candidates = resultTeams
                            .map((team, idx) => ({ 
                                idx, 
                                fCount: team.members.filter(m => m.gender === '여성').length,
                                tCount: team.members.length,
                                score: team.scoreSum,
                                target: team.targetSize,
                                hasTopMale: team.hasTopMale
                            }))
                            .filter(t => t.tCount + unit.members.length <= t.target);
                        if (unit.isTopFemale) candidates = candidates.filter(c => !c.hasTopMale);
                        if (unit.isTopMale) candidates = candidates.filter(c => !resultTeams[c.idx].hasTopFemale);
                        let targetIdx = -1;
                        if (candidates.length > 0) {
                            const sortedCandidates = candidates.sort((a, b) => {
                                if (Math.abs(a.score - b.score) < 0.5) return Math.random() - 0.5;
                                if (isFemalePriority && unit.hasFemale) {
                                    return (a.fCount - b.fCount) || (a.score - b.score);
                                }
                                return (a.score - b.score) || (a.tCount - b.tCount);
                            });
                            targetIdx = sortedCandidates[0].idx;
                        } else {
                            targetIdx = resultTeams.findIndex(t => t.members.length < t.targetSize);
                        }

                        resultTeams[targetIdx].members.push(...unit.members);
                        resultTeams[targetIdx].scoreSum += unit.totalPoints;
                        if (unit.isTopMale) resultTeams[targetIdx].hasTopMale = true;
                        if (unit.isTopFemale) resultTeams[targetIdx].hasTopFemale = true;
                    });
                };

                assignByBalancedRandom(unitsToAssign.filter(u => u.hasFemale), true);
                assignByBalancedRandom(unitsToAssign.filter(u => !u.hasFemale), false);

                const finalTeams = resultTeams.map(t => {
                    const reordered = reorderMembersWithGenderRule(t.members);
                    return { members: reordered, scoreSum: Math.round(t.scoreSum * 10) / 10 };
                });

                setTeams(finalTeams);
                setActiveTab('results');
            };

            const confirmTeams = () => {
                setIsConfirmed(true);
                localStorage.setItem('otp_confirmed_teams', JSON.stringify({
                    teams,
                    updatedAt: new Date().toISOString()
                }));
                alert('편성이 확정되었습니다!\n이제 재편성하기 전까지 이 상태가 유지됩니다.');
            };

            const moveItem = (sourceTeamIdx, sourceMemberIdx, targetTeamIdx, targetMemberIdx) => {
                if (sourceTeamIdx === targetTeamIdx && sourceMemberIdx === targetMemberIdx) return;

                const newTeams = [...teams];
                const sourceTeam = newTeams[sourceTeamIdx];
                const targetTeam = newTeams[targetTeamIdx];

                const [movedMember] = sourceTeam.members.splice(sourceMemberIdx, 1);
                
                if (sourceTeamIdx === targetTeamIdx) {
                    const actualTargetIdx = (targetMemberIdx === null || targetMemberIdx === undefined) 
                        ? targetTeam.members.length 
                        : targetMemberIdx;
                    targetTeam.members.splice(actualTargetIdx, 0, movedMember);
                } else {
                    if (targetMemberIdx === undefined || targetMemberIdx === null) {
                        targetTeam.members.push(movedMember);
                    } else {
                        targetTeam.members.splice(targetMemberIdx, 0, movedMember);
                    }
                }

                sourceTeam.scoreSum = Math.round(sourceTeam.members.reduce((acc, cur) => acc + cur.points, 0) * 10) / 10;
                if (sourceTeamIdx !== targetTeamIdx) {
                    targetTeam.scoreSum = Math.round(targetTeam.members.reduce((acc, cur) => acc + cur.points, 0) * 10) / 10;
                }

                newTeams[sourceTeamIdx].members = reorderMembersWithGenderRule(newTeams[sourceTeamIdx].members);
                if (sourceTeamIdx !== targetTeamIdx) {
                    newTeams[targetTeamIdx].members = reorderMembersWithGenderRule(newTeams[targetTeamIdx].members);
                }

                setTeams(newTeams);
            };

            const handleDragStart = (e, teamIdx, memberIdx) => {
                setDraggedItem({ teamIdx, memberIdx });
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e, teamIdx, memberIdx) => {
                e.preventDefault(); 
                if (dragOverItem?.teamIdx !== teamIdx || dragOverItem?.memberIdx !== memberIdx) {
                    setDragOverItem({ teamIdx, memberIdx });
                }
            };

            const handleDragEnd = () => {
                setDraggedItem(null);
                setDragOverItem(null);
            };

            const handleDrop = (e, targetTeamIdx, targetMemberIdx) => {
                e.preventDefault();
                setDragOverItem(null); 
                if (!draggedItem) return;
                moveItem(draggedItem.teamIdx, draggedItem.memberIdx, targetTeamIdx, targetMemberIdx);
                setDraggedItem(null);
            };

            const handleTouchStart = (e, teamIdx, memberIdx, memberData) => {
                if (!e.touches || e.touches.length === 0) return;
                const touch = e.touches[0];
                const startX = touch.clientX;
                const startY = touch.clientY;
                isScrollingRef.current = false;
                longPressTimerRef.current = setTimeout(() => {
                    if (!isScrollingRef.current) {
                        if (navigator.vibrate) navigator.vibrate(50);
                        setDraggedItem({ teamIdx, memberIdx });
                        setMobileGhost({ memberData, initialX: startX, initialY: startY });
                    }
                }, 500);
            };

            const handleTouchMove = (e) => {
                if (draggedItem) {
                    if (e.cancelable) e.preventDefault(); 
                    if (!e.touches || e.touches.length === 0) return;
                    const touch = e.touches[0];
                    if (ghostCardRef.current) {
                        ghostCardRef.current.style.left = `${touch.clientX}px`;
                        ghostCardRef.current.style.top = `${touch.clientY}px`;
                    }
                    const element = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (element) {
                        const memberEl = element.closest('[data-member-idx]');
                        const teamEl = element.closest('[data-team-idx]');
                        if (memberEl) {
                            const tIdx = parseInt(memberEl.dataset.teamIdx);
                            const mIdx = parseInt(memberEl.dataset.memberIdx);
                            if (dragOverItem?.teamIdx !== tIdx || dragOverItem?.memberIdx !== mIdx) {
                                setDragOverItem({ teamIdx: tIdx, memberIdx: mIdx });
                            }
                        } else if (teamEl) {
                            const tIdx = parseInt(teamEl.dataset.teamIdx);
                            if (dragOverItem?.teamIdx !== tIdx || dragOverItem?.memberIdx !== null) {
                                setDragOverItem({ teamIdx: tIdx, memberIdx: null }); 
                            }
                        }
                    }
                } else {
                    isScrollingRef.current = true;
                    if (longPressTimerRef.current) {
                        clearTimeout(longPressTimerRef.current);
                        longPressTimerRef.current = null;
                    }
                }
            };

            const handleTouchEnd = (e) => {
                if (longPressTimerRef.current) {
                    clearTimeout(longPressTimerRef.current);
                    longPressTimerRef.current = null;
                }
                if (draggedItem) {
                    if (dragOverItem) {
                        moveItem(draggedItem.teamIdx, draggedItem.memberIdx, dragOverItem.teamIdx, dragOverItem.memberIdx);
                    }
                    setDraggedItem(null);
                    setMobileGhost(null);
                    setDragOverItem(null);
                }
            };

            const handleContextMenu = (e) => {
                e.preventDefault();
                e.stopPropagation();
                return false;
            };

            const confirmSaveDraft = async () => {
                setIsProcessing(true);
                try {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    await getCol('team_drafts').add({
                        meetingDate, meetingTimeRange: `${meetingTime.start} ~ ${meetingTime.end}`,
                        createdAt: now.toISOString(), timeLabel: timeStr, teams, managerName: syncManagerName 
                    });
                    setIsSaveModalOpen(false);
                } catch (e) { alert("저장 중 오류가 발생했습니다."); }
                finally { setIsProcessing(false); }
            };

            const openDeleteModal = (id) => {
                setTargetDeleteId(id);
                setIsDeleteModalOpen(true);
            };

            const confirmDeleteDraft = async () => {
                if (!targetDeleteId) return;
                setIsProcessing(true);
                try {
                    await getCol('team_drafts').doc(targetDeleteId).delete();
                    setIsDeleteModalOpen(false);
                    setTargetDeleteId(null);
                } catch (e) { alert("삭제 처리 중 오류가 발생했습니다."); }
                finally { setIsProcessing(false); }
            };

            const loadDraft = (draft) => { setTeams(draft.teams); setSyncManagerName(draft.managerName || ""); setActiveTab('results'); };

            const captureIndividualTeams = async () => {
                setIsCapturing(true);
                try {
                    for (let i = 0; i < teams.length; i++) {
                        const element = teamRefs.current[i];
                        if (element) {
                            const levelTags = element.querySelectorAll('.level-tag');
                            levelTags.forEach(tag => tag.style.display = 'none');
                            const canvas = await html2canvas(element, { backgroundColor: '#f1f5f9', scale: 2 });
                            const link = document.createElement('a');
                            link.href = canvas.toDataURL('image/png'); link.download = `${meetingDate}_TEAM_${i + 1}.png`;
                            link.click();
                            levelTags.forEach(tag => tag.style.display = 'inline-flex');
                        }
                    }
                } catch (e) {}
                setIsCapturing(false);
            };

            const captureAllInOne = async () => {
                setIsCapturing(true);
                const container = document.createElement('div');
                container.style.padding = '40px'; container.style.backgroundColor = '#f1f5f9';
                container.style.width = '1200px'; container.style.display = 'grid';
                container.style.gridTemplateColumns = 'repeat(3, 1fr)'; container.style.gap = '20px';
                container.style.position = 'fixed'; container.style.top = '-9999px';
                const header = document.createElement('div');
                header.style.gridColumn = 'span 3'; header.style.textAlign = 'center'; header.style.marginBottom = '30px';
                header.innerHTML = `<h1 style="font-size: 36px; font-weight: 900; color: #0f172a; margin-bottom: 8px;">OTP FC TEAM LIST</h1><div style="font-size: 16px; font-weight: 700; color: #64748b;">DATE: ${meetingDate} (${meetingTime.start} ~ ${meetingTime.end}) | MANAGER: ${syncManagerName}</div>`;
                container.appendChild(header); document.body.appendChild(container);
                teamRefs.current.forEach((ref) => {
                    if (ref) {
                        const clone = ref.cloneNode(true);
                        clone.querySelectorAll('.level-tag').forEach(tag => tag.remove());
                        clone.style.width = '100%'; clone.style.transform = 'none';
                        clone.style.boxShadow = 'none'; clone.style.border = '1px solid #e2e8f0';
                        container.appendChild(clone);
                    }
                });
                try {
                    const canvas = await html2canvas(container, { backgroundColor: '#f1f5f9', scale: 2 });
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png'); link.download = `${meetingDate}_ALL_TEAMS.png`;
                    link.click();
                } catch (e) {}
                document.body.removeChild(container); setIsCapturing(false);
            };

            // Font File Drop Handler
            const handleFontFileDrop = (e) => {
                e.preventDefault();
                setIsDraggingFile(false);
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.ttf') || file.name.endsWith('.otf') || file.name.endsWith('.woff') || file.name.endsWith('.woff2'))) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const fontData = event.target.result;
                        const fontName = 'CustomUploadedFont';
                        const fontFace = new FontFace(fontName, `url(${fontData})`);
                        
                        fontFace.load().then((loadedFace) => {
                            document.fonts.add(loadedFace);
                            // CSS Variables Update to apply new font globally
                            document.documentElement.style.setProperty('--main-font', `'${fontName}', sans-serif`);
                            document.documentElement.style.setProperty('--bold-font', `'${fontName}', sans-serif`);
                            document.documentElement.style.setProperty('--light-font', `'${fontName}', sans-serif`);
                            setCustomFontName(file.name);
                            alert(`폰트가 "${file.name}"(으)로 변경되었습니다!`);
                        }).catch(err => {
                            console.error('Font loading failed:', err);
                            alert('폰트 로드 실패: 유효한 폰트 파일인지 확인해주세요.');
                        });
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('ttf, otf, woff 파일만 지원합니다.');
                }
            };

            return (
                <div className="max-w-7xl mx-auto p-4 sm:p-6 pb-24 text-left">
                    <header className="mb-8 text-center text-slate-900">
                        {/* italic 클래스 제거 */}
                        <h1 className="text-4xl font-black tracking-tighter uppercase mb-3">Team Maker</h1>
                        <div className="flex flex-col items-center gap-3">
                            <div className="inline-flex flex-col items-center bg-white px-6 py-3 rounded-[24px] border border-slate-200 shadow-sm transition-all hover:shadow-md">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="text-sm font-black text-blue-600 uppercase tracking-widest">{meetingDate || 'Syncing...'}</span>
                                    {meetingTime.start && (
                                        <React.Fragment>
                                            <div className="w-px h-3 bg-slate-200" />
                                            <span className="text-sm font-black text-green-600 flex items-center gap-1"><Icon.Clock /> {meetingTime.start} ~ {meetingTime.end}</span>
                                        </React.Fragment>
                                    )}
                                </div>
                                <span className="text-xs font-bold text-slate-400">{selectedList.length}명 참여 확정</span>
                            </div>
                            {syncManagerName && (
                                <div className="flex items-center gap-2 text-blue-600 font-bold text-xs uppercase tracking-wide bg-blue-50 px-5 py-2 rounded-full border border-blue-100 shadow-sm">
                                    <Icon.Shield /> <span className="font-black underline decoration-2 underline-offset-4 decoration-blue-200">{syncManagerName}</span>
                                </div>
                            )}
                        </div>
                    </header>

                    <nav className="flex gap-2 mb-8 bg-slate-200/50 p-1.5 rounded-2xl max-w-2xl mx-auto">
                        {['generator', 'results', 'drafts', 'settings'].map(t => (
                            <button key={t} onClick={() => setActiveTab(t)} className={`flex-1 py-3 rounded-xl font-black text-xs sm:text-sm transition-all ${activeTab === t ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>
                                {t === 'generator' ? '설정 및 생성' : t === 'results' ? '현재 편성' : t === 'drafts' ? '저장소' : '설정'}
                            </button>
                        ))}
                    </nav>

                    {activeTab === 'generator' && (
                        <div className="space-y-6 animate-fade-in text-left max-w-5xl mx-auto text-slate-900">
                            <div className="bg-white p-6 rounded-[32px] border border-slate-200 shadow-sm">
                                <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6 border-b border-slate-50 pb-4">
                                    <div className="flex items-center gap-2 text-left">
                                        <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest text-left">Entry Pool</h3>
                                        <span className="text-[10px] font-black text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full">{selectedList.length}명</span>
                                    </div>
                                    <div className="flex flex-wrap gap-x-4 gap-y-2 items-center">
                                        {[1,2,3,4,5,6].map(lvl => (
                                            <div key={lvl} className="flex items-center gap-1.5">
                                                <span className={`w-5 h-5 flex items-center justify-center rounded font-black text-[10px] ${getLevelColor(lvl)}`}>{lvl}</span>
                                                <span className="text-sm font-black text-slate-700">{levelStats[lvl]}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 max-h-[500px] overflow-y-auto custom-scrollbar pr-2">
                                    {(() => {
                                        const sortMembers = (list) => {
                                            return [...list].sort((a, b) => {
                                                const memberA = members.find(m => m.id === a.memberId) || {};
                                                const memberB = members.find(m => m.id === b.memberId) || {};
                                                
                                                const nA = parseInt(memberA.level || a.level || 99);
                                                const nB = parseInt(memberB.level || b.level || 99);
                                                const sA = nA > 6 ? nA - 6 : nA;
                                                const sB = nB > 6 ? nB - 6 : nB;
                                                
                                                if (sA !== sB) return sA - sB;
                                                return (memberA.name || a.name || '').localeCompare(memberB.name || b.name || '');
                                            });
                                        };

                                        const maleMembers = selectedList.filter(p => {
                                            const m = members.find(x => x.id === p.memberId) || {};
                                            return (m.gender || p.gender || '남성') === '남성';
                                        });

                                        const femaleMembers = selectedList.filter(p => {
                                            const m = members.find(x => x.id === p.memberId) || {};
                                            return (m.gender || p.gender || '남성') === '여성';
                                        });

                                        const renderMemberCard = (p) => {
                                            const lvl = members.find(m => m.id === p.memberId)?.level || p.level;
                                            return (
                                                <div key={p.id} className="px-3 py-2 bg-slate-100 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 flex items-center gap-2 shadow-sm">
                                                    <div className="flex items-center gap-1 text-left text-slate-900 leading-none">
                                                        <span className="font-black text-slate-800">{p.name}</span>
                                                        {p.gender === '여성' && <span className="text-[10px] font-black px-1.5 py-0.5 bg-pink-100 text-pink-600 rounded flex-shrink-0">W</span>}
                                                        {p.isGuest && <span className="text-[9px] font-black bg-blue-600 text-white px-1.5 rounded flex-shrink-0">G</span>}
                                                    </div>
                                                    <span className={`text-[10px] font-black px-1.5 py-0.5 rounded-lg level-tag ${getLevelColor(lvl)}`}>{lvl}</span>
                                                </div>
                                            );
                                        };

                                        return (
                                            <>
                                                <div className="flex flex-col gap-2">
                                                    <div className="sticky top-0 bg-white/95 backdrop-blur z-10 py-2 border-b border-slate-100 flex justify-between items-center mb-2">
                                                        <span className="text-xs font-black text-blue-600 flex items-center gap-1.5 uppercase tracking-wider">
                                                            Male Player 
                                                            <span className="bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full text-[10px]">{maleMembers.length}</span>
                                                        </span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 content-start min-h-[50px]">
                                                        {maleMembers.length === 0 ? (
                                                            <div className="w-full text-center py-4 text-xs text-slate-300 font-bold">남성 플레이어가 없습니다.</div>
                                                        ) : sortMembers(maleMembers).map(renderMemberCard)}
                                                    </div>
                                                </div>

                                                <div className="flex flex-col gap-2 md:border-l md:border-slate-50 md:pl-4">
                                                    <div className="sticky top-0 bg-white/95 backdrop-blur z-10 py-2 border-b border-slate-100 flex justify-between items-center mb-2">
                                                        <span className="text-xs font-black text-pink-500 flex items-center gap-1.5 uppercase tracking-wider">
                                                            Female Player
                                                            <span className="bg-pink-100 text-pink-600 px-2 py-0.5 rounded-full text-[10px]">{femaleMembers.length}</span>
                                                        </span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 content-start min-h-[50px]">
                                                        {femaleMembers.length === 0 ? (
                                                            <div className="w-full text-center py-4 text-xs text-slate-300 font-bold">여성 플레이어가 없습니다.</div>
                                                        ) : sortMembers(femaleMembers).map(renderMemberCard)}
                                                    </div>
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>

                            <div className="bg-white p-8 rounded-[40px] border border-slate-200 shadow-lg text-slate-900 text-left">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-8 mb-8 text-left">
                                    <div className="flex flex-col gap-2 text-left text-slate-900">
                                        <label className="text-[10px] font-black text-slate-400 ml-1 uppercase text-left">Team Count</label>
                                        <select className="p-4 bg-slate-50 rounded-2xl font-black text-lg text-left" value={teamingSettings.teamCount} onChange={e => setTeamingSettings({...teamingSettings, teamCount: parseInt(e.target.value)})}>
                                            {[2,3,4,5,6].map(v => <option key={v} value={v}>{v}개 팀 균등 편성</option>)}
                                        </select>
                                    </div>
                                    <div className="flex items-end">
                                        <label className="w-full flex items-center justify-between p-4 bg-slate-50 rounded-2xl border-2 border-transparent hover:border-blue-100 transition-all cursor-pointer">
                                            <span className="text-xs font-black text-slate-600">커플 무조건 동반 배정</span>
                                            <input type="checkbox" checked={teamingSettings.keepCouples} onChange={e => setTeamingSettings({...teamingSettings, keepCouples: e.target.checked})} className="w-6 h-6 accent-blue-600 rounded" />
                                        </label>
                                    </div>
                                </div>
                                <div className="p-5 bg-blue-50 border border-blue-100 rounded-3xl mb-8">
                                    <h4 className="text-xs font-black text-blue-600 uppercase mb-2 flex items-center gap-1.5">
                                        <Icon.Info /> Smart Balancing Engine
                                    </h4>
                                    <ul className="text-[11px] text-slate-600 font-bold space-y-1.5 text-left">
                                        <li>• <span className="text-blue-700 font-black">격리 로직:</span> 1단 남성과 7단 여성은 어떤 경우에도 무조건 다른 팀으로 먼저 분리됩니다.</li>
                                        <li>• <span className="text-blue-700 font-black">균등 인원:</span> 총 인원을 팀 수로 나눈 수치를 수학적으로 엄격히 준수합니다.</li>
                                        <li>• <span className="text-blue-700 font-black">무작위성:</span> 결과 고착화를 방지하기 위해 배정 순서와 후보 팀 선택에 랜덤 노이즈를 부여합니다.</li>
                                    </ul>
                                </div>
                                <button onClick={generateTeams} className="w-full py-5 bg-blue-600 text-white rounded-[24px] font-black text-lg shadow-xl shadow-blue-100 hover:bg-blue-700 transition-all">편성 시작</button>
                            </div>
                        </div>
                    )}

                    {activeTab === 'results' && (
                        <div className="animate-fade-in text-slate-900 text-left">
                            {/* Confirmed Banner */}
                            {isConfirmed && (
                                <div className="bg-green-100 border-2 border-green-400 text-green-700 px-4 py-2 rounded-2xl mb-4 flex items-center justify-center gap-2 animate-fade-in">
                                    <Icon.Check /> <span className="font-black text-sm">확정된 편성입니다 (자동 저장 중)</span>
                                </div>
                            )}

                            {/* Mobile Ghost Card (follows touch) */}
                            {mobileGhost && draggedItem && (
                                <div 
                                    ref={ghostCardRef}
                                    className="ghost-card bg-white p-3 rounded-2xl border-2 border-blue-500 flex items-center justify-between"
                                    style={{ left: mobileGhost.initialX, top: mobileGhost.initialY }}
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 font-black text-xs">
                                            {draggedItem.memberIdx + 1}
                                        </div>
                                        <div className="flex flex-col">
                                            <div className="flex items-center gap-1">
                                                <span className="font-black text-slate-900 text-sm">{mobileGhost.memberData.name}</span>
                                                {mobileGhost.memberData.gender === '여성' && <span className="text-[9px] font-black px-1 py-0.5 bg-pink-100 text-pink-600 rounded">W</span>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className={`text-[10px] font-black px-2 py-1 rounded level-tag ${getLevelColor(mobileGhost.memberData.level)}`}>
                                        {mobileGhost.memberData.level}
                                    </div>
                                </div>
                            )}

                            {teams.length === 0 ? (
                                <div className="py-20 text-center text-slate-300 font-black">결과가 없습니다.</div>
                            ) : (
                                <>
                                    <div className="grid grid-cols-3 gap-1.5 md:gap-4 text-left">
                                        {teams.map((team, idx) => (
                                            <div 
                                                key={idx} 
                                                ref={el => teamRefs.current[idx] = el} 
                                                className="team-card bg-white rounded-2xl md:rounded-[32px] shadow-lg md:shadow-xl overflow-hidden border border-slate-100 text-left h-full flex flex-col"
                                                data-team-idx={idx}
                                                onDragOver={(e) => {
                                                    e.preventDefault();
                                                    handleDragOver(e, idx, null); // Container hover implies dragging to end/empty space
                                                }}
                                                onDrop={(e) => {
                                                    e.preventDefault();
                                                    handleDrop(e, idx, null);
                                                }}
                                                onTouchMove={handleTouchMove}
                                                onTouchEnd={handleTouchEnd}
                                            >
                                                <div className={`p-2 md:p-4 text-center font-black text-white flex flex-col md:flex-row justify-between items-center px-2 md:px-6 ${idx === 0 ? 'bg-rose-500' : idx === 1 ? 'bg-blue-500' : idx === 2 ? 'bg-emerald-600' : idx === 3 ? 'bg-orange-500' : 'bg-violet-600'}`}>
                                                    <div className="flex flex-col md:flex-row items-center gap-0.5 md:gap-2">
                                                        <span className="text-[10px] md:text-base uppercase tracking-tight text-white whitespace-nowrap">Team {idx + 1}</span>
                                                        <span className="text-[8px] md:text-[10px] bg-black/20 px-1.5 py-0.5 rounded-full font-black text-white whitespace-nowrap">{team.scoreSum} pts</span>
                                                    </div>
                                                    <span className="text-[8px] md:text-[10px] font-bold opacity-80 uppercase text-white mt-1 md:mt-0">{team.members.length} 명</span>
                                                </div>
                                                <div className="p-1.5 md:p-4 space-y-1 md:space-y-2 text-left min-h-[100px] flex-grow">
                                                    {team.members.map((m, mIdx) => {
                                                        const isPartnerPresent = m.coupleId && selectedList.some(p => p.memberId === m.coupleId);
                                                        const isDragging = draggedItem?.teamIdx === idx && draggedItem?.memberIdx === mIdx;
                                                        const isDragTarget = dragOverItem?.teamIdx === idx && dragOverItem?.memberIdx === mIdx;

                                                        return (
                                                            <div 
                                                                key={mIdx}
                                                                data-team-idx={idx}
                                                                data-member-idx={mIdx}
                                                                draggable
                                                                onDragStart={(e) => handleDragStart(e, idx, mIdx)}
                                                                onDragOver={(e) => {
                                                                    e.preventDefault();
                                                                    e.stopPropagation(); 
                                                                    handleDragOver(e, idx, mIdx);
                                                                }}
                                                                onDragEnd={handleDragEnd}
                                                                onDrop={(e) => {
                                                                    e.stopPropagation(); 
                                                                    handleDrop(e, idx, mIdx);
                                                                }}
                                                                onTouchStart={(e) => handleTouchStart(e, idx, mIdx, m)}
                                                                // Prevent Context Menu on Long Press
                                                                onContextMenu={handleContextMenu}
                                                                // Move/End handlers are on container for broader hit area, but can propagate
                                                                className={`relative transition-all duration-200 touch-action-none ${isDragging ? 'dragging' : ''} ${isDragTarget ? 'pt-12' : ''}`}
                                                            >
                                                                {isDragTarget && (
                                                                    <div className="absolute top-0 left-0 right-0 h-10 border-2 border-dashed border-blue-400 bg-blue-50/50 rounded-xl flex items-center justify-center pointer-events-none transform -translate-y-1">
                                                                        <span className="text-blue-500 font-bold text-xs">이 위치로 이동</span>
                                                                    </div>
                                                                )}

                                                                <div className={`flex items-center justify-between p-1.5 md:p-3 bg-slate-50 rounded-lg md:rounded-2xl transition-all shadow-sm border border-slate-100/50 md:border-transparent cursor-move select-none ${!isDragging ? 'hover:bg-blue-50 hover:border-blue-300 hover:shadow-md hover:scale-[1.02] hover:z-10 relative' : ''}`}>
                                                                    <div className="flex items-center gap-1.5 md:gap-3 text-left overflow-hidden">
                                                                        <span className="w-4 h-4 md:w-6 md:h-6 flex items-center justify-center rounded-full text-[8px] md:text-[9px] font-black flex-shrink-0 bg-slate-200 text-slate-500">{mIdx + 1}</span>
                                                                        <div className="flex flex-col text-left overflow-hidden">
                                                                            <div className="flex items-center gap-1 text-left text-slate-900 leading-none">
                                                                                <span className="font-black text-slate-800 text-[10px] md:text-sm truncate">{m.name}</span>
                                                                                {m.gender === '여성' && <span className="text-[8px] md:text-[9px] font-black px-1 py-0.5 bg-pink-100 text-pink-600 rounded flex-shrink-0">W</span>}
                                                                                {m.isGuest && <span className="text-[6px] md:text-[8px] font-black bg-blue-100 text-blue-600 px-0.5 md:px-1 rounded-sm flex-shrink-0">G</span>}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex items-center gap-1 md:gap-2 flex-shrink-0">
                                                                        <div className="flex flex-col items-end text-slate-900 text-right">
                                                                            <span className={`text-[8px] md:text-[10px] font-black px-1 md:px-1.5 py-0.5 rounded level-tag inline-flex items-center justify-center min-w-[16px] md:min-w-[20px] ${getLevelColor(m.level)}`}>
                                                                                {m.level}
                                                                            </span>
                                                                            {isPartnerPresent && <div className="text-pink-400 mt-0.5 md:mt-0.5 text-[8px] md:text-[10px]"><Icon.Heart /></div>}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                    
                                                    {dragOverItem?.teamIdx === idx && dragOverItem?.memberIdx === null && (
                                                        <div className="h-10 border-2 border-dashed border-blue-400 bg-blue-50/50 rounded-xl mt-2 flex items-center justify-center pointer-events-none animate-pulse">
                                                            <span className="text-blue-500 font-bold text-xs">맨 뒤로 이동</span>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-10 p-6 bg-white rounded-[40px] border border-slate-200 shadow-lg space-y-6 max-w-4xl mx-auto text-left text-slate-900">
                                        <div className="flex flex-col sm:flex-row gap-3 justify-center text-left">
                                            <button onClick={generateTeams} className="flex-1 flex items-center justify-center gap-2 px-6 py-4 bg-slate-900 text-white rounded-2xl font-black text-sm hover:bg-slate-800 transition-all text-left"><Icon.Refresh /> 다시 편성</button>
                                            <button onClick={() => setIsSaveModalOpen(true)} className="flex-1 flex items-center justify-center gap-2 px-6 py-4 bg-blue-600 text-white rounded-2xl font-black text-sm shadow-xl hover:bg-blue-700 transition-all text-left"><Icon.Bookmark /> 현재 편성 임시저장</button>
                                            <button onClick={confirmTeams} className={`flex-1 flex items-center justify-center gap-2 px-6 py-4 rounded-2xl font-black text-sm shadow-xl transition-all text-left ${isConfirmed ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-slate-200 hover:bg-slate-300 text-slate-600'}`}><Icon.Check /> {isConfirmed ? '확정됨' : '편성 확정'}</button>
                                        </div>
                                        <div className="border-t border-slate-100 pt-6 text-left">
                                            <p className="text-center text-[11px] font-black text-slate-400 uppercase tracking-widest mb-4">Export Options</p>
                                            <div className="flex flex-col sm:flex-row gap-3 justify-center text-left">
                                                <button onClick={captureIndividualTeams} disabled={isCapturing} className="flex-1 max-w-xs flex items-center justify-center gap-2 px-8 py-4 bg-slate-100 text-slate-700 rounded-2xl font-black text-xs hover:bg-slate-200 transition-all disabled:opacity-50 text-left text-slate-700"><Icon.Camera /> 팀별 개별 저장</button>
                                                <button onClick={captureAllInOne} disabled={isCapturing} className="flex-1 max-w-xs flex items-center justify-center gap-2 px-8 py-4 bg-blue-50 text-blue-600 rounded-2xl font-black text-xs hover:bg-blue-100 transition-all disabled:opacity-50 text-left text-blue-600"><Icon.Download /> 한 장으로 저장 (3팀씩)</button>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    )}

                    {activeTab === 'drafts' && (
                        <div className="animate-fade-in space-y-4 text-left max-w-3xl mx-auto text-slate-900">
                            {savedDrafts.length === 0 ? (
                                <div className="py-20 text-center text-slate-300 font-black">기록이 없습니다.</div>
                            ) : savedDrafts.map(draft => (
                                <div key={draft.id} className="bg-white p-6 rounded-[32px] border border-slate-200 shadow-sm flex items-center justify-between transition-all hover:border-blue-300 text-slate-900">
                                    <div className="text-left text-slate-900">
                                        <p className="text-lg font-black">{draft.timeLabel} 편성</p>
                                        <div className="flex flex-col gap-1 mt-1 text-slate-900 text-left leading-none">
                                            <div className="flex gap-2 items-center leading-none text-slate-900 text-left">
                                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left">{draft.meetingDate}</span>
                                                {draft.meetingTimeRange && (
                                                    <React.Fragment>
                                                        <div className="w-px h-2 bg-slate-200 text-left" />
                                                        <span className="text-[10px] font-bold text-green-600 uppercase tracking-widest text-left">{draft.meetingTimeRange}</span>
                                                    </React.Fragment>
                                                )}
                                                <div className="w-px h-2 bg-slate-200 text-left" />
                                                <span className="text-[10px] font-bold text-blue-500 uppercase tracking-widest text-left">{draft.teams.length}개 팀</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 text-left">
                                        <button onClick={() => loadDraft(draft)} className="px-5 py-2.5 bg-blue-50 text-blue-600 rounded-xl font-black text-xs hover:bg-blue-100 transition-all text-left text-blue-600">불러오기</button>
                                        <button onClick={() => openDeleteModal(draft.id)} className="p-2.5 text-slate-300 hover:text-red-500 transition-all text-left text-slate-300"><Icon.Trash /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {activeTab === 'settings' && (
                        <div className="animate-fade-in text-left max-w-xl mx-auto text-slate-900">
                            <div className="bg-white p-8 rounded-[40px] border border-slate-200 shadow-lg text-slate-900 text-left">
                                <h3 className="text-xl font-black mb-6 text-slate-800 flex items-center gap-2">
                                    <Icon.Settings /> 폰트 설정
                                </h3>
                                
                                <div className="mb-8">
                                    <p className="text-sm font-bold text-slate-500 mb-2">현재 적용된 폰트</p>
                                    <div className="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                        <p className="font-black text-lg text-blue-600">{customFontName}</p>
                                    </div>
                                </div>

                                <div 
                                    className={`relative p-8 rounded-3xl border-2 border-dashed transition-all cursor-pointer ${isDraggingFile ? 'dropzone-active' : 'border-slate-300 bg-slate-50 hover:bg-slate-100'}`}
                                    onDragOver={(e) => { e.preventDefault(); setIsDraggingFile(true); }}
                                    onDragLeave={(e) => { e.preventDefault(); setIsDraggingFile(false); }}
                                    onDrop={handleFontFileDrop}
                                >
                                    <div className="flex flex-col items-center justify-center text-center gap-3 py-4 pointer-events-none">
                                        <div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-2">
                                            <Icon.Upload />
                                        </div>
                                        <p className="font-black text-slate-700">폰트 파일(.ttf)을 여기로 드래그하세요</p>
                                        <p className="text-xs font-medium text-slate-400 max-w-[200px] leading-relaxed">
                                            ttf, otf, woff 파일을 지원하며<br/>드롭 즉시 전체 폰트가 변경됩니다.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {isSaveModalOpen && (
                        <div className="fixed inset-0 z-[10000] flex items-center justify-center p-4 modal-backdrop">
                            <div className="bg-white w-full max-w-sm rounded-[32px] shadow-2xl overflow-hidden animate-fade-in p-8 text-center">
                                <div className="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <Icon.AlertCircle />
                                </div>
                                <h3 className="text-xl font-black text-slate-900 mb-2">편성안 저장</h3>
                                <p className="text-sm font-bold text-slate-500 mb-8 leading-relaxed">
                                    현재 구성된 팀 편성 결과(3개 팀)를<br/>저장소에 임시로 기록하시겠습니까?
                                </p>
                                <div className="flex gap-3">
                                    <button onClick={() => setIsSaveModalOpen(false)} className="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all text-slate-600">취소</button>
                                    <button onClick={confirmSaveDraft} disabled={isProcessing} className="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black text-sm shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all disabled:opacity-50">
                                        {isProcessing ? "저장 중..." : "저장하기"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isDeleteModalOpen && (
                        <div className="fixed inset-0 z-[10000] flex items-center justify-center p-4 modal-backdrop text-slate-900">
                            <div className="bg-white w-full max-w-sm rounded-[32px] shadow-2xl overflow-hidden animate-fade-in p-8 text-center">
                                <div className="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <Icon.Trash />
                                </div>
                                <h3 className="text-xl font-black text-slate-900 mb-2">기록 삭제</h3>
                                <p className="text-sm font-bold text-slate-500 mb-8 leading-relaxed">
                                    해당 편성 기록을 영구적으로 삭제하시겠습니까?<br/>삭제된 데이터는 복구할 수 없습니다.
                                </p>
                                <div className="flex gap-3">
                                    <button onClick={() => {setIsDeleteModalOpen(false); setTargetDeleteId(null);}} className="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all">취소</button>
                                    <button onClick={confirmDeleteDraft} disabled={isProcessing} className="flex-1 py-4 bg-rose-600 text-white rounded-2xl font-black text-sm shadow-lg shadow-rose-100 hover:bg-rose-700 transition-all disabled:opacity-50">
                                        {isProcessing ? "삭제 중..." : "삭제하기"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
