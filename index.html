<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTP FC Team Maker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #f1f5f9;
            user-select: none;
        }
        .team-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .team-card:hover { transform: translateY(-4px); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        button:active { transform: scale(0.96); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[9999]">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-bold text-slate-500">데이터 동기화 중...</p>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCAcQzliuWJTB8vPm9gb0vsyR8pIAx7YTw",
            authDomain: "otp-fc-check.firebaseapp.com",
            projectId: "otp-fc-check",
            storageBucket: "otp-fc-check.firebasestorage.app",
            messagingSenderId: "907414776392",
            appId: "1:907414776392:web:0a29a660bb956e5a40467d"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = 'otp-fc-attendance';

        const getCol = (name) => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(name);

        const Icon = {
            Refresh: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
            Heart: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>,
            Layout: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>,
            Bookmark: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>,
            Trash: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        };

        function App() {
            const [members, setMembers] = useState([]);
            const [sessionData, setSessionData] = useState([]);
            const [savedDrafts, setSavedDrafts] = useState([]);
            const [meetingDate, setMeetingDate] = useState('');
            const [teamingSettings, setTeamingSettings] = useState({
                teamCount: 3,
                keepCouples: true
            });
            const [teams, setTeams] = useState([]);
            const [activeTab, setActiveTab] = useState('generator');

            useEffect(() => {
                const init = async () => {
                    try {
                        await auth.signInAnonymously();
                        document.getElementById('loading-screen').style.display = 'none';
                    } catch (e) { console.error(e); }
                };
                init();

                const unsubMembers = getCol('members').onSnapshot(snap => setMembers(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubSession = getCol('weekly_session').onSnapshot(snap => setSessionData(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubSettings = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc('meeting_time').onSnapshot(doc => {
                    if (doc.exists) setMeetingDate(doc.data().date);
                });
                const unsubDrafts = getCol('team_drafts').onSnapshot(snap => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setSavedDrafts(data.sort((a,b) => b.createdAt.localeCompare(a.createdAt)));
                });
                return () => { unsubMembers(); unsubSession(); unsubSettings(); unsubDrafts(); };
            }, []);

            const selectedList = useMemo(() => {
                if (!meetingDate) return [];
                return sessionData.filter(s => s.date === meetingDate && s.status !== '노쇼');
            }, [sessionData, meetingDate]);

            // --- 팀 편성 알고리즘 (균등 배분 및 랜덤성 강화) ---
            const generateTeams = () => {
                const { teamCount, keepCouples } = teamingSettings;
                const totalAttendees = selectedList.length;

                if (totalAttendees < teamCount) {
                    alert("참여 인원이 팀 수보다 적습니다.");
                    return;
                }

                // 1. 참여자 데이터 가공
                let pool = selectedList.map(p => {
                    const original = members.find(m => m.id === p.memberId) || {};
                    return {
                        ...p,
                        level: parseInt(p.level || original.level || 99),
                        coupleId: original.coupleId || '',
                        gender: p.gender || original.gender || '남성'
                    };
                });

                // 2. 그룹화 (커플 우선 묶기)
                let units = [];
                let processedIds = new Set();
                if (keepCouples) {
                    pool.forEach(p => {
                        if (!processedIds.has(p.id)) {
                            if (p.coupleId) {
                                const partner = pool.find(o => o.memberId === p.coupleId && !processedIds.has(o.id));
                                if (partner) {
                                    units.push({ members: [p, partner], avgLevel: (p.level + partner.level) / 2 });
                                    processedIds.add(p.id); processedIds.add(partner.id);
                                    return;
                                }
                            }
                            units.push({ members: [p], avgLevel: p.level });
                            processedIds.add(p.id);
                        }
                    });
                } else {
                    units = pool.map(p => ({ members: [p], avgLevel: p.level }));
                }

                // [무작위성] 등급별 균등 분배를 위해 실력순 정렬 후 동일 실력 내 셔플
                units.sort((a, b) => (a.avgLevel - b.avgLevel) || (Math.random() - 0.5));
                
                // 3. 인원 배분 계산 (균등 배분)
                const baseCount = Math.floor(totalAttendees / teamCount);
                const remainder = totalAttendees % teamCount;
                const targetSizes = Array(teamCount).fill(baseCount);
                for (let i = 0; i < remainder; i++) targetSizes[i]++;

                const resultTeams = Array.from({ length: teamCount }, () => []);
                
                // [무작위성] 배정 시작 팀 랜덤화
                let currentIdx = Math.floor(Math.random() * teamCount);
                let direction = Math.random() > 0.5 ? 1 : -1;

                // 4. Snake Draft 방식 배정 (Capacity 준수)
                units.forEach(unit => {
                    let assigned = false;
                    let attempts = 0;
                    
                    while (!assigned && attempts < teamCount) {
                        const target = (currentIdx + teamCount) % teamCount;
                        if (resultTeams[target].length + unit.members.length <= targetSizes[target]) {
                            resultTeams[target].push(...unit.members);
                            assigned = true;
                            currentIdx = target;
                        } else {
                            currentIdx += direction;
                            attempts++;
                        }
                    }

                    if (!assigned) {
                        const minTeam = resultTeams.reduce((prev, curr) => prev.length <= curr.length ? prev : curr);
                        minTeam.push(...unit.members);
                    }

                    currentIdx += direction;
                    if (currentIdx >= teamCount) { currentIdx = teamCount - 1; direction = -1; }
                    else if (currentIdx < 0) { currentIdx = 0; direction = 1; }
                });

                // 5. 팀 내부 정렬 (여성 3번/6번 고정 및 실력순)
                const finalTeams = resultTeams.map(teamMembers => {
                    const currentTeamSize = teamMembers.length;
                    if (currentTeamSize === 0) return { members: [] };

                    const females = teamMembers.filter(m => m.gender === '여성').sort((a, b) => a.level - b.level);
                    const slot3 = (currentTeamSize >= 3 && females.length > 0) ? females.shift() : null;
                    const slot6 = (currentTeamSize >= 6 && females.length > 0) ? females.shift() : null;

                    const others = teamMembers
                        .filter(m => m !== slot3 && m !== slot6)
                        .sort((a, b) => a.level - b.level);

                    const reordered = Array(currentTeamSize).fill(null);
                    if (slot3) reordered[2] = slot3;
                    if (slot6) reordered[5] = slot6;

                    for (let i = 0; i < currentTeamSize; i++) {
                        if (reordered[i] === null) {
                            const nextPerson = others.shift();
                            if (nextPerson) reordered[i] = nextPerson;
                        }
                    }

                    return { members: reordered.filter(m => m !== null) };
                });

                setTeams(finalTeams);
                setActiveTab('results');
            };

            const saveDraft = async () => {
                if (teams.length === 0) return;
                try {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    await getCol('team_drafts').add({
                        meetingDate, createdAt: now.toISOString(),
                        timeLabel: timeStr, teams
                    });
                    alert("성공적으로 저장되었습니다.");
                } catch (e) { alert("저장 실패"); }
            };

            const loadDraft = (draft) => { setTeams(draft.teams); setActiveTab('results'); };
            const deleteDraft = async (id) => { if (confirm("삭제하시겠습니까?")) await getCol('team_drafts').doc(id).delete(); };

            return (
                <div className="max-w-4xl mx-auto p-4 sm:p-8 pb-24 text-left">
                    <header className="mb-10 text-center text-slate-900">
                        <h1 className="text-4xl font-black italic tracking-tighter uppercase mb-2">Team Maker</h1>
                        <div className="inline-flex items-center gap-2 bg-white px-4 py-1.5 rounded-full border border-slate-200 shadow-sm">
                            <span className="text-xs font-black text-blue-600 uppercase tracking-widest">{meetingDate || 'Syncing...'}</span>
                            <div className="w-px h-3 bg-slate-200" />
                            <span className="text-xs font-bold text-slate-500">{selectedList.length}명 대기 중</span>
                        </div>
                    </header>

                    <nav className="flex gap-2 mb-8 bg-slate-200/50 p-1.5 rounded-2xl">
                        {['generator', 'results', 'drafts'].map(t => (
                            <button key={t} onClick={() => setActiveTab(t)} className={`flex-1 py-3 rounded-xl font-black text-xs sm:text-sm transition-all ${activeTab === t ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>
                                {t === 'generator' ? '설정 및 생성' : t === 'results' ? '현재 편성' : '저장소'}
                            </button>
                        ))}
                    </nav>

                    {activeTab === 'generator' && (
                        <div className="space-y-6 animate-fade-in text-left">
                            <div className="bg-white p-6 rounded-[32px] border border-slate-200 shadow-sm">
                                <h3 className="text-xs font-black text-slate-400 mb-4 uppercase tracking-widest">Entry Pool</h3>
                                <div className="flex flex-wrap gap-2 max-h-48 overflow-y-auto custom-scrollbar pr-2">
                                    {selectedList.length === 0 ? (
                                        <p className="text-sm text-slate-300 font-bold py-4 text-center w-full">선정된 인원이 없습니다.</p>
                                    ) : selectedList.sort((a,b)=>a.name.localeCompare(b.name)).map(p => (
                                        <div key={p.id} className="px-3 py-1.5 bg-slate-50 border border-slate-100 rounded-lg text-xs font-bold text-slate-600 flex items-center gap-1.5">
                                            {p.name}
                                            {p.gender === '여성' && <span className="text-[9px] font-black text-pink-500">W</span>}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-white p-8 rounded-[40px] border border-slate-200 shadow-lg text-left">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-8 mb-8 text-left">
                                    <div className="flex flex-col gap-2">
                                        <label className="text-[10px] font-black text-slate-400 ml-1 uppercase">Team Count</label>
                                        <select className="p-4 bg-slate-50 rounded-2xl font-black text-lg" value={teamingSettings.teamCount} onChange={e => setTeamingSettings({...teamingSettings, teamCount: parseInt(e.target.value)})}>
                                            {[2,3,4,5,6].map(v => <option key={v} value={v}>{v}개 팀 균등 편성</option>)}
                                        </select>
                                    </div>
                                    <div className="flex items-end">
                                        <label className="w-full flex items-center justify-between p-4 bg-slate-50 rounded-2xl border-2 border-transparent hover:border-blue-100 transition-all cursor-pointer">
                                            <span className="text-xs font-black text-slate-600">커플 무조건 동반 배정</span>
                                            <input type="checkbox" checked={teamingSettings.keepCouples} onChange={e => setTeamingSettings({...teamingSettings, keepCouples: e.target.checked})} className="w-6 h-6 accent-blue-600 rounded" />
                                        </label>
                                    </div>
                                </div>
                                <div className="p-5 bg-blue-50/50 border border-blue-100 rounded-3xl mb-8">
                                    <h4 className="text-xs font-black text-blue-600 uppercase mb-2">Balancing Logic</h4>
                                    <ul className="text-[11px] text-slate-600 font-bold space-y-1.5">
                                        <li>• <span className="text-blue-700">인원수 정렬:</span> 모든 팀의 인원수를 동일하게 맞춥니다 (오차 1명 이내).</li>
                                        <li>• <span className="text-blue-700">등급별 분배:</span> 동일 등급 내 완전 랜덤 셔플로 모든 경우의 수가 나오도록 설계했습니다.</li>
                                        <li>• <span className="text-blue-700">슬롯 고정:</span> 여성은 3번, 6번 자리에 실력순으로 우선 자동 배치됩니다.</li>
                                    </ul>
                                </div>
                                <button onClick={generateTeams} className="w-full py-5 bg-blue-600 text-white rounded-[24px] font-black text-lg shadow-xl shadow-blue-100 hover:bg-blue-700 transition-all">랜덤 팀 편성 실행</button>
                            </div>
                        </div>
                    )}

                    {activeTab === 'results' && (
                        <div className="animate-fade-in">
                            {teams.length === 0 ? (
                                <div className="py-20 text-center text-slate-300 font-black">결과가 없습니다.</div>
                            ) : (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                                        {teams.map((team, idx) => (
                                            <div key={idx} className="team-card bg-white rounded-[40px] shadow-xl overflow-hidden border border-slate-100">
                                                <div className={`p-5 text-center font-black text-white flex justify-between items-center px-8 ${idx === 0 ? 'bg-rose-500' : idx === 1 ? 'bg-blue-500' : idx === 2 ? 'bg-emerald-600' : 'bg-orange-500'}`}>
                                                    <span className="text-lg">TEAM {idx + 1}</span>
                                                    <span className="text-xs opacity-75">{team.members.length}명</span>
                                                </div>
                                                <div className="p-6 space-y-2">
                                                    {team.members.map((m, mIdx) => (
                                                        <div key={mIdx} className="flex items-center justify-between p-3.5 bg-slate-50 rounded-2xl hover:bg-white transition-all shadow-sm">
                                                            <div className="flex items-center gap-4">
                                                                <span className={`w-7 h-7 flex items-center justify-center rounded-full text-[10px] font-black ${mIdx === 2 || mIdx === 5 ? 'bg-blue-600 text-white ring-2 ring-blue-100' : 'bg-slate-200 text-slate-500'}`}>{mIdx + 1}</span>
                                                                <div className="flex flex-col text-left">
                                                                    <span className="font-black text-slate-800 text-lg leading-none">{m.name}</span>
                                                                    {m.isGuest && <span className="text-[8px] font-black text-blue-400 mt-1 uppercase tracking-tighter">Guest</span>}
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-3">
                                                                {m.gender === '여성' && <span className="text-[10px] font-black px-1.5 py-0.5 bg-pink-100 text-pink-600 rounded">W</span>}
                                                                <div className="flex flex-col items-end text-slate-900">
                                                                    <span className="text-xs font-black text-slate-400">{m.level}단</span>
                                                                    {m.coupleId && <div className="text-pink-400 mt-0.5"><Icon.Heart /></div>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-10 flex flex-col sm:flex-row gap-4 justify-center">
                                        <button onClick={generateTeams} className="flex-1 max-w-xs flex items-center justify-center gap-2 px-8 py-5 bg-slate-900 text-white rounded-3xl font-black text-sm shadow-lg hover:bg-slate-800 transition-all">
                                            <Icon.Refresh /> 기준 유지하고 다시 섞기
                                        </button>
                                        <button onClick={saveDraft} className="flex-1 max-w-xs flex items-center justify-center gap-2 px-8 py-5 bg-blue-600 text-white rounded-3xl font-black text-sm shadow-xl hover:bg-blue-700 transition-all">
                                            <Icon.Bookmark /> 현재 편성 임시저장
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    )}

                    {activeTab === 'drafts' && (
                        <div className="animate-fade-in space-y-4 text-left">
                            {savedDrafts.length === 0 ? (
                                <div className="py-20 text-center text-slate-300 font-black">기록이 없습니다.</div>
                            ) : savedDrafts.map(draft => (
                                <div key={draft.id} className="bg-white p-6 rounded-[32px] border border-slate-200 shadow-sm flex items-center justify-between transition-all hover:border-blue-300">
                                    <div className="text-left">
                                        <p className="text-lg font-black text-slate-900">{draft.timeLabel} 편성</p>
                                        <div className="flex gap-2 mt-1 text-slate-900">
                                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{draft.meetingDate}</span>
                                            <div className="w-px h-2 bg-slate-200" />
                                            <span className="text-[10px] font-bold text-blue-500 uppercase tracking-widest">{draft.teams.length}개 팀</span>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => loadDraft(draft)} className="px-5 py-2.5 bg-blue-50 text-blue-600 rounded-xl font-black text-xs hover:bg-blue-100 transition-all">불러오기</button>
                                        <button onClick={() => deleteDraft(draft.id)} className="p-2.5 text-slate-300 hover:text-red-500 transition-all"><Icon.Trash /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>